<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>VR Panorama Viewer con Profundidad</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { margin: 0; }
    canvas { display: block; }
  </style>
</head>
<body>
<script type="module">
  import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js';
  import { VRButton } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/webxr/VRButton.js';

  let camera, scene, renderer;
  let mesh;

  init();
  animate();

  function init() {
    scene = new THREE.Scene();

    camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);

    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.xr.enabled = true;
    document.body.appendChild(renderer.domElement);
    document.body.appendChild(VRButton.createButton(renderer));

    // Cargar texturas: panorama y mapa de profundidad
    const loader = new THREE.TextureLoader();
    const texture = loader.load('office.jpg');
    const depthTexture = loader.load('office_depth.jpg'); // Debes tener este archivo, mapa de profundidad

    texture.mapping = THREE.EquirectangularReflectionMapping;
    depthTexture.minFilter = THREE.LinearFilter;
    depthTexture.magFilter = THREE.LinearFilter;

    // Geometría: esfera invertida para panorama
    const geometry = new THREE.SphereGeometry(500, 60, 40);
    geometry.scale(-1, 1, 1);

    // Material personalizado con mapa de profundidad
    const material = new THREE.ShaderMaterial({
      uniforms: {
        map: { value: texture },
        depthMap: { value: depthTexture },
        cameraPos: { value: camera.position },
      },
      vertexShader: `
        varying vec2 vUv;
        varying vec3 vPosition;

        void main() {
          vUv = uv;
          vPosition = position;
          gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
        }
      `,
      fragmentShader: `
        uniform sampler2D map;
        uniform sampler2D depthMap;
        varying vec2 vUv;

        void main() {
          vec4 color = texture2D(map, vUv);
          float depth = texture2D(depthMap, vUv).r;

          // Modificamos el color basado en profundidad para simular efecto de profundidad
          // Ejemplo simple: oscurecer según profundidad
          color.rgb *= 1.0 - depth * 0.5;

          gl_FragColor = color;
        }
      `
    });

    mesh = new THREE.Mesh(geometry, material);
    scene.add(mesh);

    window.addEventListener('resize', onWindowResize);
  }

  function onWindowResize() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  }

  function animate() {
    renderer.setAnimationLoop(() => {
      renderer.render(scene, camera);
    });
  }
</script>
</body>
</html>
