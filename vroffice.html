<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>VR Panorama Viewer with Character</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { 
      margin: 0; 
      overflow: hidden;
      font-family: Arial, sans-serif;
    }
    canvas { 
      display: block; 
    }
    
    /* Estilos para el sistema de di√°logos */
    #dialogContainer {
      display: none;
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: 80%;
      max-width: 800px;
      z-index: 500;
    }

    #dialogContainer>div {
      background: rgba(0, 0, 0, 0.8);
      border: 3px solid #3A86FF;
      border-radius: 10px;
      padding: 20px;
      color: white;
      font-family: 'Courier New', monospace;
      max-height: 60vh;
      overflow-y: auto;
    }

    #speakerName {
      font-weight: bold;
      color: #ada9e6;
      margin-bottom: 10px;
    }

    #dialogText {
      margin-bottom: 15px;
      line-height: 1.4;
      animation: typewriter 0.05s steps(1) infinite;
    }

    #dialogOptions {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .dialog-option {
      padding: 10px;
      background: rgba(30, 23, 19, 0.5);
      border: 1px solid #2D3748;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.2s;
      text-align: left;
    }

    .dialog-option:hover {
      background: linear-gradient(to right, rgba(59, 131, 246, 0.383), rgba(222, 21, 209, 0.5));
    }

    #continueButton {
      margin-top: 15px;
      padding: 8px 15px;
      background: #4a5057;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      display: none;
    }

    #continueButton:hover {
      background: linear-gradient(to right, rgba(59, 131, 246, 0.383), rgba(222, 21, 209, 0.5));
    }

    @keyframes typewriter {
      from { opacity: 0.8; }
      to { opacity: 1; }
    }
    
    #info {
      position: absolute;
      top: 10px;
      width: 100%;
      text-align: center;
      color: white;
      background-color: rgba(0, 0, 0, 0.5);
      padding: 10px;
      z-index: 100;
    }
    
    /* Elemento para mostrar el bot√≥n VR */
    #vr-button-container {
      position: absolute;
      bottom: 20px;
      right: 20px;
      z-index: 100;
    }
  </style>
</head>

<!-- Elementos de audio -->
<audio id="dialogSound" preload="auto">
  <source src="m.e.mp3" type="audio/mpeg">
</audio>

<body>
  <div id="info">VR Panorama - Ac√©rcate al personaje para interactuar</div>
  <div id="vr-button-container"></div>
  
  <!-- Sistema de di√°logos -->
  <div id="dialogContainer">
    <div>
      <div id="speakerName">LOUISE</div>
      <div id="dialogText"></div>
      <div id="dialogOptions"></div>
      <button id="continueButton">Continuar</button>
    </div>
  </div>

  <script type="module">
    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js';
    import { VRButton } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/webxr/VRButton.js';
    import { FBXLoader } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/loaders/FBXLoader.js';

    let camera, scene, renderer;
    let character, mixer, idleAction, currentAction;
    let isNearLouise = false;
    let hasStartedDialog = false;
    const DIALOG_TRIGGER_DISTANCE = 3.0;
    
    // Variables para el sistema de di√°logos
    let currentDialogTree = null;
    let currentDialogNode = null;
    let isDialogTyping = false;
    let dialogTimeout = null;
    let currentTextPart = 0;
    let dialogTextParts = [];
    
    // Definici√≥n de di√°logos profesionales
    const dialogs = {
      start: {
        text: "¬°Hola! Bienvenido a PlayDual L√°cteos, el lugar donde el queso no solo se produce... ¬°tambi√©n se aprende! üßÄ\n\nSoy Louise, secretaria de planta. Aqu√≠ podr√°s explorar c√≥mo funciona una planta real de producci√≥n de quesos, conocer√°s nuestras √°reas clave y, si est√°s aplicando a una vacante, te haremos algunas preguntas para ver qu√© tan afinado est√° tu perfil.\n\nDime, ¬øqu√© te gustar√≠a hacer hoy?",
        options: [
          { text: "Me interesa conocer como funciona la planta", next: "func_planta" },
          { text: "Estoy aplicando para un puesto como ingeniero industrial.", next: "entrevista" },
          { text: "Solo estoy explorando por inter√©s general..", next: "greeting" }
        ],
        character: "LOUISE"
      },
      func_planta: {
        text: "¬°Perfecto! Antes de dejarte pasar al √°rea de producci√≥n, necesito saber si tienes algunas nociones b√°sicas del trabajo que realizamos aqu√≠. Te har√© unas preguntas r√°pidas. No te preocupes, es solo para conocer tu nivel de familiaridad.",
        options: [
          { text: "¬°De acuerdo, estoy listo!", next: "start_a" },
          { text: "Creo que necesito estudiar un poco m√°s...", next: "insecure_a" }
        ],
        character: "LOUISE"
      },
      start_a: {
        text: "¬øCu√°l crees que es la funci√≥n principal de un ingeniero industrial en una planta de producci√≥n?",
        options: [
          {
            text: "Aplicar m√©todos cuantitativos y herramientas de an√°lisis para mejorar continuamente los procesos, reduciendo tiempos, costos y desperdicios sin comprometer la calidad del producto final.",
            next: "correct1"
          },
          {
            text: "Implementar √∫nicamente sistemas de mantenimiento correctivo y supervisar directamente la operaci√≥n de maquinaria en cada turno.",
            next: "incorrect1"
          },
          {
            text: "Dise√±ar exclusivamente los protocolos de control microbiol√≥gico y f√≠sico-qu√≠mico en productos l√°cteos, cumpliendo con normativas sanitarias internacionales.",
            next: "incorrect1"
          }
        ],
        character: "LOUISE"
      },
      correct1: {
        text: "¬°Correcto! Esa es una descripci√≥n precisa del rol del ingeniero industrial. Has demostrado tener una buena base.",
        options: [
          { text: "Continuar con la siguiente pregunta", next: "next_question_a" },
          { text: "Volver al inicio", next: "start" }
        ],
        character: "LOUISE"
      },
      incorrect1: {
        text: "No es del todo correcto. Esa funci√≥n corresponde a otro perfil profesional. No te preocupes, puedes intentarlo de nuevo o seguir explorando.",
        options: [
          { text: "Intentar de nuevo", next: "start_a" },
          { text: "Volver al inicio", next: "start" }
        ],
        character: "LOUISE"
      },
      next_question_a: {
        text: "Excelente, ahora vamos con la siguiente pregunta. ¬øQu√© herramientas consideras esenciales para un ingeniero industrial en una planta de producci√≥n?",
        options: [
          {
            text: "Sistemas de ejecuci√≥n de manufactura (MES), herramientas de an√°lisis estad√≠stico como Minitab, simuladores de procesos (Arena, FlexSim) y enfoques de mejora como Lean Six Sigma.",
            next: "correct2"
          },
          {
            text: "Planos en AutoCAD, software de edici√≥n de im√°genes, y herramientas ofim√°ticas como Excel y PowerPoint.",
            next: "incorrect2"
          },
          {
            text: "Sistemas de control num√©rico (CNC) sin integraci√≥n con sistemas de gesti√≥n de calidad o procesos de mejora continua.",
            next: "incorrect2"
          }
        ],
        character: "LOUISE"
      },
      incorrect2: {
        text: "Esa respuesta es demasiado b√°sica y no refleja las herramientas avanzadas que un ingeniero industrial debe manejar. Intenta pensar en metodolog√≠as y tecnolog√≠as m√°s espec√≠ficas para la optimizaci√≥n de procesos.",
        options: [
          { text: "Intentar de nuevo", next: "next_question_a" },
          { text: "Volver al inicio", next: "start" }
        ],
        character: "LOUISE"
      },
      correct2: {
        text: "¬°Muy bien! Has identificado las herramientas clave que un ingeniero industrial debe dominar para optimizar procesos y mejorar la eficiencia en la planta.",
        options: [
          { text: "Continuar con la siguiente pregunta", next: "next_question_b" },
          { text: "Volver al inicio", next: "start" }
        ],
        character: "LOUISE"
      },
      next_question_b: {
        text: "Ahora, una pregunta m√°s. Ante un escenario sostenido de ineficiencia en una l√≠nea de producci√≥n automatizada, ¬øcu√°l ser√≠a el enfoque m√°s robusto y estructurado para diagnosticar y mitigar la causa ra√≠z del problema?",
        options: [
          {
            text: "Aplicar mantenimiento aut√≥nomo bajo los principios de TPM, revisar los hist√≥ricos de OEE, e implementar planes de acci√≥n correctiva para las estaciones con mayor variabilidad en los tiempos de ciclo.",
            next: "incorrect3aa"
          },
          {
            text: "Implementar un enfoque basado en datos mediante la recopilaci√≥n de KPIs en tiempo real a trav√©s de sensores IoT, realizar un an√°lisis estad√≠stico multivariable con herramientas como Minitab o Python, identificar cuellos de botella con mapas de flujo de valor (VSM), y aplicar DMAIC de Six Sigma para ejecutar soluciones sostenibles.",
            next: "correctl"
          },
          {
            text: "Utilizar herramientas de control estad√≠stico de procesos (SPC) para monitorear variaciones, aplicar Kaizen para peque√±as mejoras continuas y reforzar la formaci√≥n del personal operativo en pr√°cticas estandarizadas.",
            next: "incorrect3ab"
          }
        ],
        character: "LOUISE"
      },
      correctl: {
        text: "¬°Correcto! Has demostrado un buen entendimiento de las metodolog√≠as y herramientas necesarias para abordar problemas complejos en la producci√≥n.",
        text2: " Tu perfil parece alinearse con lo que buscamos.",
        text3: " ¬øTe gustar√≠a explorar m√°s sobre la planta o prefieres conocer m√°s sobre la oficina?",
        options: [
          { text: " Explorar la planta", next: "explorar_planta" },
          { text: "Explorar la oficia", next: "explorar_off" }
        ],
        character: "LOUISE"
      },
      incorrect3aa: {
        text: "Esa estrategia aborda s√≠ntomas, pero no ataca la ra√≠z del problema. Aunque TPM y OEE son √∫tiles, no se integran con tecnolog√≠as emergentes ni con an√°lisis predictivo en tiempo real. Intenta pensar en un enfoque m√°s integral, que combine herramientas estad√≠sticas avanzadas con metodolog√≠as estructuradas como DMAIC y tecnolog√≠as IoT.",
        options: [
          { text: "Intentar de nuevo", next: "fabrica_1" },
          { text: "Volver al inicio", next: "start" }
        ],
        character: "LOUISE"
      },
      incorrect3ab: {
        text: "Buena intenci√≥n, pero limitada. Estas acciones ayudan a estabilizar procesos, pero no garantizan un an√°lisis profundo de las causas ra√≠z ni aprovechan datos en tiempo real para una mejore sostenible. Busca un enfoque m√°s hol√≠stico, apoyado en datos y tecnolog√≠a avanzada.",
        options: [
          { text: "Intentar de nuevo", next: "next_question_b" },
          { text: "Volver al inicio", next: "start" }
        ],
        character: "LOUISE"
      },
      greeting: {
        text: "¬°Qu√© amable! Si necesitas algo, aqu√≠ estar√©. Buen d√≠a.",
        options: [],
        character: "LOUISE"
      },
      end_helpful: {
        text: "Perfecto. No dudes en preguntar si necesitas algo m√°s. Estoy aqu√≠ para ayudar.",
        options: [],
        character: "LOUISE"
      },
      entrevista: {
        text: "Version beta en desarrollo. Por favor, vuelve m√°s tarde.",
        character: "LOUISE"
      },
    };

    init();
    animate();

    function init() {
      // Crear escena
      scene = new THREE.Scene();

      // C√°mara
      camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);

      // Renderizador
      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.xr.enabled = true;
      document.body.appendChild(renderer.domElement);
      
      // A√±adir bot√≥n VR
      document.getElementById('vr-button-container').appendChild(VRButton.createButton(renderer));

      // Cargar imagen panor√°mica
      const loader = new THREE.TextureLoader();
      loader.load('Office1.jpg', function (texture) {
        texture.mapping = THREE.EquirectangularReflectionMapping;
        scene.background = texture;
        
        // Una vez cargado el panorama, cargar el personaje
        loadCharacter();
      });

      // Configurar sistema de di√°logos
      setupDialogSystem();
      setupInteraction();

      // Redimensionar
      window.addEventListener('resize', onWindowResize);
      
      // Configurar eventos de teclado
      document.addEventListener('keydown', (e) => {
        if (e.code === 'KeyE' && isNearLouise && !hasStartedDialog) {
          hasStartedDialog = true;
          startDialog(dialogs);
        }
      });
    }

    function loadCharacter() {
      const loader = new FBXLoader();
      
      loader.load(
        'louise/Idle.fbx',
        (fbx) => {
          character = fbx;
          character.position.set(0, 0, -3); // Posicionar frente al usuario
          character.scale.set(0.01, 0.01, 0.01);
          character.name = 'Louise';
          
          // Configurar animaciones
          if (fbx.animations && fbx.animations.length > 0) {
            mixer = new THREE.AnimationMixer(character);
            idleAction = mixer.clipAction(fbx.animations[0]);
            idleAction.setLoop(THREE.LoopRepeat);
            idleAction.play();
            currentAction = idleAction;
          }
          
          scene.add(character);
          console.log('Personaje cargado correctamente');
        },
        undefined,
        (error) => {
          console.error('Error al cargar el personaje:', error);
        }
      );
    }

    function getDistanceToCharacter() {
      if (!character || !camera) return Infinity;
      return camera.position.distanceTo(character.position);
    }

    function onWindowResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function animate() {
      renderer.setAnimationLoop(() => {
        // Actualizar animaciones
        if (mixer) {
          mixer.update(0.016); // Delta time aproximado para 60fps
        }
        
        // Verificar proximidad al personaje
        checkProximity();
        
        renderer.render(scene, camera);
      });
    }
    
    function checkProximity() {
      const distance = getDistanceToCharacter();
      
      if (distance <= DIALOG_TRIGGER_DISTANCE) {
        if (!isNearLouise) {
          isNearLouise = true;
          document.getElementById('info').textContent = "Presiona E para hablar con Louise";
        }
      } else {
        if (isNearLouise) {
          isNearLouise = false;
          document.getElementById('info').textContent = "VR Panorama - Ac√©rcate al personaje para interactuar";
          
          if (hasStartedDialog) {
            endDialog();
            hasStartedDialog = false;
          }
        }
      }
    }
    
    /***********************/
    /* SISTEMA DE DI√ÅLOGOS */
    /***********************/
    
    function setupDialogSystem() {
      // Evento para continuar
      document.getElementById('continueButton').addEventListener('click', () => {
        if (isDialogTyping) {
          finishTyping();
          return;
        }

        // Si hay m√°s partes de texto por mostrar
        if (currentTextPart < dialogTextParts.length - 1) {
          currentTextPart++;
          showTextPart(dialogTextParts[currentTextPart]);
        } else {
          // Si no hay m√°s partes, mostrar opciones o cerrar di√°logo
          if (currentDialogNode.options && currentDialogNode.options.length > 0) {
            showDialogOptions();
          } else {
            endDialog();
          }
        }
      });
    }
    
    function setupInteraction() {
      // Configurar eventos de teclado para interacci√≥n
      document.addEventListener('keydown', (e) => {
        if (e.code === 'KeyE' && isNearLouise && !hasStartedDialog) {
          hasStartedDialog = true;
          startDialog(dialogs);
        }
      });
    }
    
    function startDialog(dialogTree) {
      // Mostrar contenedor de di√°logo
      const dialogContainer = document.getElementById('dialogContainer');
      dialogContainer.style.display = 'block';

      // Configurar di√°logo inicial
      currentDialogTree = dialogTree;
      showDialogNode('start');
    }
    
    function showDialogNode(nodeId) {
      const node = dialogs[nodeId];
      if (!node) return endDialog();

      currentDialogNode = node;
      document.getElementById('speakerName').textContent = node.character || 'LOUISE';

      // Cambiar a animaci√≥n de hablar
      if (mixer && idleAction) {
        if (currentAction) currentAction.stop();
        idleAction.reset().play();
        currentAction = idleAction;
      }

      // Dividir el texto en partes
      splitDialogText(node.text);

      // Mostrar la primera parte del texto
      currentTextPart = 0;
      showTextPart(dialogTextParts[currentTextPart]);

      // Ocultar opciones inicialmente
      document.getElementById('dialogOptions').innerHTML = '';
      document.getElementById('continueButton').style.display = 'none';
    }
    
    function splitDialogText(text) {
      const maxCharsPerPart = 200;
      dialogTextParts = [];

      if (text.length <= maxCharsPerPart) {
        dialogTextParts.push(text);
        return;
      }

      const paragraphs = text.split('\n\n');

      for (const paragraph of paragraphs) {
        if (paragraph.length > maxCharsPerPart) {
          const sentences = paragraph.split(/(?<=[.!?])\s+/);
          let currentPart = '';

          for (const sentence of sentences) {
            if (currentPart.length + sentence.length > maxCharsPerPart && currentPart.length > 0) {
              dialogTextParts.push(currentPart.trim());
              currentPart = sentence;
            } else {
              currentPart += (currentPart.length > 0 ? ' ' : '') + sentence;
            }
          }

          if (currentPart.length > 0) {
            dialogTextParts.push(currentPart.trim());
          }
        } else {
          dialogTextParts.push(paragraph);
        }
      }
    }
    
    function showTextPart(part) {
      isDialogTyping = true;
      const dialogElement = document.getElementById('dialogText');
      dialogElement.textContent = '';
      const dialogSound = document.getElementById('dialogSound');
      
      dialogSound.volume = 0.3;
      let soundTimeout;

      if (mixer && idleAction) {
        if (currentAction) currentAction.stop();
        idleAction.reset().play();
        currentAction = idleAction;
      }

      let currentIndex = 0;
      const typingInterval = setInterval(() => {
        if (currentIndex < part.length) {
          dialogElement.textContent += part[currentIndex];
          currentIndex++;
          
          // Reproducir sonido solo para caracteres visibles
          if (part[currentIndex-1] !== ' ' && part[currentIndex-1] !== '\n') {
            dialogSound.pause();
            dialogSound.currentTime = 0;
            dialogSound.play().catch(e => console.log("No se pudo reproducir sonido:", e));
          }
        } else {
          clearInterval(typingInterval);
          clearTimeout(soundTimeout);
          isDialogTyping = false;

          // Mostrar bot√≥n "Continuar" si hay m√°s partes
          if (currentTextPart < dialogTextParts.length - 1) {
            document.getElementById('continueButton').style.display = 'block';
            document.getElementById('continueButton').textContent = 'Continuar';
          }
          // Si es la √∫ltima parte, mostrar opciones o bot√≥n "Cerrar"
          else {
            if (currentDialogNode.options && currentDialogNode.options.length > 0) {
              showDialogOptions();
            } else {
              document.getElementById('continueButton').style.display = 'block';
              document.getElementById('continueButton').textContent = 'Cerrar';
            }

            // Volver a animaci√≥n Idle cuando termina de hablar
            if (mixer && idleAction) {
              if (currentAction) currentAction.stop();
              idleAction.reset().play();
              currentAction = idleAction;
            }
          }
        }
      }, 30);
    }
    
    function showDialogOptions() {
      const optionsContainer = document.getElementById('dialogOptions');
      optionsContainer.innerHTML = '';

      if (currentDialogNode.options && currentDialogNode.options.length > 0) {
        currentDialogNode.options.forEach(option => {
          const optionElement = document.createElement('div');
          optionElement.className = 'dialog-option';
          optionElement.textContent = option.text;
          optionElement.addEventListener('click', () => {
            showDialogNode(option.next);
          });
          optionsContainer.appendChild(optionElement);
        });
        document.getElementById('continueButton').style.display = 'none';
      }
    }
    
    function finishTyping() {
      clearTimeout(dialogTimeout);
      document.getElementById('dialogText').textContent = dialogTextParts[currentTextPart];
      isDialogTyping = false;
      
      // Detener el sonido
      const dialogSound = document.getElementById('dialogSound');
      dialogSound.pause();
      dialogSound.currentTime = 0;

      // Mostrar bot√≥n "Continuar" si hay m√°s partes
      if (currentTextPart < dialogTextParts.length - 1) {
        document.getElementById('continueButton').style.display = 'block';
        document.getElementById('continueButton').textContent = 'Continuar';
      }
      // Si es la √∫ltima parte, mostrar opciones o bot√≥n "Cerrar"
      else {
        if (currentDialogNode.options && currentDialogNode.options.length > 0) {
          showDialogOptions();
        } else {
          document.getElementById('continueButton').style.display = 'block';
          document.getElementById('continueButton').textContent = 'Cerrar';
        }
      }

      // Volver a animaci√≥n Idle cuando se fuerza el texto
      if (mixer && idleAction) {
        if (currentAction) currentAction.stop();
        idleAction.reset().play();
        currentAction = idleAction;
      }
    }
    
    function endDialog() {
      document.getElementById('dialogContainer').style.display = 'none';
      hasStartedDialog = false;
      
      // Detener el sonido
      const dialogSound = document.getElementById('dialogSound');
      dialogSound.pause();
      dialogSound.currentTime = 0;

      // Asegurarse de volver a la animaci√≥n Idle
      if (mixer && idleAction) {
        if (currentAction) currentAction.stop();
        idleAction.reset().play();
        currentAction = idleAction;
      }
    }
  </script>
</body>
</html>